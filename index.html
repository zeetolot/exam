<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç¸é†«åœ‹è€ƒå†’éšªè€… - V6.2 ç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; color: #1e293b; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.5); }
        .tap-effect:active { transform: scale(0.96); transition: transform 0.1s; }
        .option-btn { transition: all 0.2s; user-select: none; }
        .option-btn:active { background-color: #eef2ff; border-color: #6366f1; }
        .option-disabled { opacity: 0.3; pointer-events: none; background-color: #f3f4f6; border-color: #e5e7eb; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .year-tab.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); transform: scale(1.05); }
        html, body { height: 100%; overscroll-behavior-y: none; }
        #content-area { padding-bottom: 120px; }
        header { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 z-50 glass px-4 py-3 shadow-sm">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-black shadow-lg" id="level-circle">1</div>
                <div>
                    <h1 class="text-sm font-black text-slate-800">ç¸é†«åœ‹è€ƒå†’éšªè€…</h1>
                    <div class="w-20 h-1.5 bg-gray-200 rounded-full mt-1 overflow-hidden"><div id="xp-bar" class="h-full bg-indigo-500" style="width: 0%"></div></div>
                </div>
            </div>
            <button onclick="changeView('shop')" class="tap-effect bg-amber-50 px-3 py-1.5 rounded-xl flex items-center gap-2 border border-amber-100 shadow-sm">
                <i class="fas fa-coins text-amber-500"></i><span id="coin-count" class="font-bold text-amber-700 text-xs">0</span>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        <div id="content-area">
            
            <section id="view-home" class="space-y-6 animate-fade">
                <!-- æ¯æ—¥ä»»å‹™ -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100">
                    <h2 class="font-black text-gray-800 mb-3 flex items-center gap-2 text-sm"><i class="fas fa-calendar-check text-orange-500"></i> æ¯æ—¥ä»»å‹™</h2>
                    <div id="daily-quest-list" class="space-y-2"></div>
                </div>

                <!-- æ¨¡å¼åˆ‡æ› -->
                <div class="flex bg-gray-200 p-1 rounded-xl">
                    <button onclick="switchMode('year')" id="btn-mode-year" class="flex-1 py-3 rounded-lg text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all tap-effect">å¹´ä»½æ¨¡å¼</button>
                    <button onclick="switchMode('subject')" id="btn-mode-subject" class="flex-1 py-3 rounded-lg text-xs font-bold text-gray-500 transition-all tap-effect">ç§‘ç›®å°ˆç²¾</button>
                </div>

                <!-- å¹´ä»½æ¨¡å¼é¢æ¿ -->
                <div id="mode-year-content">
                    <div class="relative mt-4">
                        <div id="year-tabs-container" class="flex gap-2 overflow-x-auto hide-scrollbar py-2 px-1 scroll-smooth"></div>
                    </div>
                    <div class="mt-4 bg-gradient-to-br from-slate-800 to-slate-900 rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden transition-all duration-500" id="banner-year">
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-white/50 text-[10px] font-bold tracking-widest mb-1">DB STATUS</p>
                                <div class="flex items-baseline gap-2"><span class="text-3xl font-black" id="year-display">114å¹´</span></div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs opacity-60">ç´¯ç©éŒ¯é¡Œ</p>
                                <p class="font-bold text-xl text-rose-300"><span class="error-count-display">0</span> <span class="text-xs text-white">é¡Œ</span></p>
                            </div>
                        </div>
                        <div class="mt-6 flex flex-wrap gap-2 relative z-10">
                             <div class="bg-white/10 px-3 py-1.5 rounded-lg text-[10px] font-medium border border-white/10"><i class="fas fa-database text-green-400"></i> <span class="total-db-display">ç¸½: 0</span></div>
                             <div class="bg-white/10 px-3 py-1.5 rounded-lg text-[10px] font-medium border border-white/10"><i class="fas fa-list-ol text-blue-400"></i> æœ¬å€: <span id="year-q-count">0</span></div>
                        </div>
                        <i class="fas fa-layer-group absolute -right-4 -bottom-4 text-[8rem] text-white opacity-5"></i>
                    </div>
                </div>

                <!-- ç§‘ç›®æ¨¡å¼é¢æ¿ -->
                <div id="mode-subject-content" class="hidden mt-4">
                    <div class="bg-gradient-to-br from-indigo-600 to-blue-500 rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-black mb-1">å…¨ç§‘å¤§äº‚é¬¥</h3>
                                    <p class="text-xs opacity-80 mb-4">è·¨å¹´ä»½é›†ä¸­ç‰¹è¨“</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs opacity-60">ç¸½éŒ¯é¡Œ</p>
                                    <p class="font-bold text-xl text-rose-300"><span class="error-count-display">0</span> <span class="text-xs text-white">é¡Œ</span></p>
                                </div>
                            </div>
                            <div class="flex gap-2 text-[10px] font-bold">
                                <div class="bg-white/20 px-3 py-1.5 rounded-lg border border-white/10"><i class="fas fa-database"></i> <span class="total-db-display">ç¸½: 0</span></div>
                                <span class="bg-rose-500/80 px-2 py-1 rounded flex items-center gap-1"><i class="fas fa-fire"></i> éŒ¯é¡Œå„ªå…ˆ</span>
                            </div>
                        </div>
                        <i class="fas fa-brain absolute -right-4 -bottom-4 text-[8rem] text-white opacity-10"></i>
                    </div>
                </div>

                <!-- å‰¯æœ¬æŒ‰éˆ• -->
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button onclick="startDungeon('pathology')" class="dungeon-card tap-effect bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1 relative overflow-hidden">
                        <div class="flex justify-between items-center w-full"><div class="w-8 h-8 bg-red-50 text-red-500 rounded-lg flex items-center justify-center text-sm"><i class="fas fa-microscope"></i></div><span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded error-badge" data-sub="pathology">0éŒ¯</span></div>
                        <div class="text-left mt-1"><span class="block text-xs font-bold text-gray-700">ç—…ç†å­¸</span><span class="text-[10px] text-gray-400 quest-count" data-sub="pathology">0 é¡Œ</span></div>
                    </button>
                    <button onclick="startDungeon('pharmacology')" class="dungeon-card tap-effect bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1 relative overflow-hidden">
                        <div class="flex justify-between items-center w-full"><div class="w-8 h-8 bg-blue-50 text-blue-500 rounded-lg flex items-center justify-center text-sm"><i class="fas fa-pills"></i></div><span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded error-badge" data-sub="pharmacology">0éŒ¯</span></div>
                        <div class="text-left mt-1"><span class="block text-xs font-bold text-gray-700">è—¥ç†å­¸</span><span class="text-[10px] text-gray-400 quest-count" data-sub="pharmacology">0 é¡Œ</span></div>
                    </button>
                    <button onclick="startDungeon('diagnosis')" class="dungeon-card tap-effect bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1 relative overflow-hidden">
                        <div class="flex justify-between items-center w-full"><div class="w-8 h-8 bg-purple-50 text-purple-500 rounded-lg flex items-center justify-center text-sm"><i class="fas fa-flask"></i></div><span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded error-badge" data-sub="diagnosis">0éŒ¯</span></div>
                        <div class="text-left mt-1"><span class="block text-xs font-bold text-gray-700">å¯¦é©—è¨ºæ–·</span><span class="text-[10px] text-gray-400 quest-count" data-sub="diagnosis">0 é¡Œ</span></div>
                    </button>
                    <button onclick="startDungeon('general')" class="dungeon-card tap-effect bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1 relative overflow-hidden">
                        <div class="flex justify-between items-center w-full"><div class="w-8 h-8 bg-orange-50 text-orange-500 rounded-lg flex items-center justify-center text-sm"><i class="fas fa-dog"></i></div><span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded error-badge" data-sub="general">0éŒ¯</span></div>
                        <div class="text-left mt-1"><span class="block text-xs font-bold text-gray-700">æ™®é€šç–¾ç—…</span><span class="text-[10px] text-gray-400 quest-count" data-sub="general">0 é¡Œ</span></div>
                    </button>
                    <button onclick="startDungeon('infectious')" class="dungeon-card tap-effect bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1 relative overflow-hidden">
                        <div class="flex justify-between items-center w-full"><div class="w-8 h-8 bg-green-50 text-green-600 rounded-lg flex items-center justify-center text-sm"><i class="fas fa-virus"></i></div><span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded error-badge" data-sub="infectious">0éŒ¯</span></div>
                        <div class="text-left mt-1"><span class="block text-xs font-bold text-gray-700">å‚³æŸ“ç—…å­¸</span><span class="text-[10px] text-gray-400 quest-count" data-sub="infectious">0 é¡Œ</span></div>
                    </button>
                    <button onclick="startDungeon('public')" class="dungeon-card tap-effect bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-1 relative overflow-hidden">
                        <div class="flex justify-between items-center w-full"><div class="w-8 h-8 bg-cyan-50 text-cyan-600 rounded-lg flex items-center justify-center text-sm"><i class="fas fa-globe-asia"></i></div><span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded error-badge" data-sub="public">0éŒ¯</span></div>
                        <div class="text-left mt-1"><span class="block text-xs font-bold text-gray-700">å…¬å…±è¡›ç”Ÿ</span><span class="text-[10px] text-gray-400 quest-count" data-sub="public">0 é¡Œ</span></div>
                    </button>
                </div>
            </section>

            <!-- æˆ°é¬¥è¦–çª— -->
            <section id="view-battle" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeView('home')" class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-gray-400"><i class="fas fa-chevron-left"></i></button>
                    <p id="battle-subject" class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded">SUBJECT</p>
                    <div class="w-10 text-center font-black text-gray-300 text-sm" id="battle-progress">1/10</div>
                </div>
                <div class="bg-white rounded-[2rem] p-6 shadow-xl mb-6 min-h-[200px] flex items-center justify-center relative">
                    <div class="absolute -top-3 left-6 bg-indigo-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold shadow-lg" id="battle-year-tag">114å¹´</div>
                    <div id="battle-error-tag" class="hidden absolute -top-3 right-6 bg-rose-500 text-white px-3 py-1 rounded-lg text-[10px] font-bold shadow-lg"><i class="fas fa-fire mr-1"></i>éŒ¯é¡Œé‡ç·´</div>
                    <p id="question-text" class="text-lg font-bold text-center leading-relaxed text-gray-800"></p>
                </div>
                <div id="options-box" class="space-y-3"></div>
            </section>

            <!-- ç®¡ç†ä»‹é¢ -->
            <section id="view-import" class="hidden space-y-4">
                <div class="flex items-center justify-between"><h2 class="font-black text-xl">ç®¡ç†ä¸­å¿ƒ</h2><button onclick="changeView('home')"><i class="fas fa-times text-gray-400"></i></button></div>
                <div class="flex bg-gray-100 p-1 rounded-xl mb-2">
                    <button onclick="switchTab('import')" id="tab-import" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-indigo-600">åŒ¯å…¥</button>
                    <button onclick="switchTab('manage')" id="tab-manage" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500">æ¸…é™¤</button>
                    <button onclick="switchTab('backup')" id="tab-backup" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500">å‚™ä»½</button>
                </div>
                <!-- åŒ¯å…¥ -->
                <div id="panel-import" class="space-y-3">
                    <div class="flex gap-2"><select id="i-year" class="flex-1 p-2 rounded border text-sm"></select><select id="i-sub" class="flex-1 p-2 rounded border text-sm"><option value="pathology">ç¸é†«ç—…ç†å­¸</option><option value="pharmacology">ç¸é†«è—¥ç†å­¸</option><option value="diagnosis">å¯¦é©—è¨ºæ–·å­¸</option><option value="general">æ™®é€šç–¾ç—…å­¸</option><option value="infectious">å‚³æŸ“ç—…å­¸</option><option value="public">å…¬å…±è¡›ç”Ÿå­¸</option></select></div>
                    <textarea id="i-q" class="w-full h-32 p-3 rounded border text-sm" placeholder="é¡Œç›®..."></textarea>
                    <textarea id="i-a" class="w-full h-24 p-3 rounded border text-sm" placeholder="ç­”æ¡ˆ..."></textarea>
                    <button onclick="doImport()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">è§£æä¸¦å­˜æª”</button>
                </div>
                <!-- æ¸…é™¤ -->
                <div id="panel-manage" class="hidden space-y-3">
                    <div class="flex gap-2"><select id="m-year" class="flex-1 p-2 rounded border text-sm"></select><select id="m-sub" class="flex-1 p-2 rounded border text-sm"><option value="all">å…¨ç§‘</option><option value="pathology">ç—…ç†</option><option value="pharmacology">è—¥ç†</option><option value="diagnosis">è¨ºæ–·</option><option value="general">æ™®é€š</option><option value="infectious">å‚³æŸ“</option><option value="public">å…¬è¡›</option></select></div>
                    <div class="p-4 bg-white rounded border"><p>æ•¸é‡: <span id="m-count" class="font-bold">0</span></p></div>
                    <button onclick="doClear()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold">æ¸…é™¤è³‡æ–™</button>
                    <hr class="border-gray-200 my-4">
                    <button onclick="clearErrors()" class="w-full border-2 border-rose-500 text-rose-500 py-3 rounded-xl font-bold">æ¸…ç©ºéŒ¯é¡Œæœ¬</button>
                </div>
                <!-- å‚™ä»½ -->
                <div id="panel-backup" class="hidden space-y-3">
                    <textarea id="b-code" class="w-full h-32 p-3 rounded border text-xs" placeholder="å‚™ä»½ç¢¼..."></textarea>
                    <div class="flex gap-2"><button onclick="doExport()" class="flex-1 bg-gray-800 text-white py-3 rounded-xl">åŒ¯å‡º</button><button onclick="doRestore()" class="flex-1 bg-green-600 text-white py-3 rounded-xl">é‚„åŸ</button></div>
                </div>
            </section>

            <!-- å•†åº— -->
            <section id="view-shop" class="hidden space-y-4">
                <div class="flex justify-between"><h2 class="font-black text-2xl">å•†åº—</h2><button onclick="changeView('home')"><i class="fas fa-times"></i></button></div>
                <div class="bg-white p-5 rounded-3xl shadow-sm flex justify-between items-center">
                    <div class="flex items-center gap-4"><div class="w-12 h-12 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-magic"></i></div><div><p class="font-bold">äºŒé¸ä¸€</p><p class="text-xs text-gray-400">åˆªé™¤2éŒ¯èª¤</p></div></div>
                    <button onclick="useItem()" class="bg-amber-500 text-white px-5 py-2 rounded-xl font-bold text-xs shadow-lg">100 <i class="fas fa-coins"></i></button>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal -->
    <div id="msg-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-xl">
            <div id="m-icon" class="text-4xl mb-3"></div><h3 id="m-title" class="text-xl font-bold mb-2"></h3><p id="m-desc" class="text-sm text-gray-500 mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        let db = {}, state = { lv:1, xp:0, coin:0, year:'114', mode:'year', errs:{pathology:[],pharmacology:[],diagnosis:[],general:[],infectious:[],public:[]} };
        const subMap = {pathology:'ç¸é†«ç—…ç†å­¸',pharmacology:'ç¸é†«è—¥ç†å­¸',diagnosis:'å¯¦é©—è¨ºæ–·å­¸',general:'æ™®é€šç–¾ç—…å­¸',infectious:'å‚³æŸ“ç—…å­¸',public:'å…¬å…±è¡›ç”Ÿå­¸'};
        const shortMap = {pathology:'ç—…ç†',pharmacology:'è—¥ç†',diagnosis:'è¨ºæ–·',general:'æ™®é€š',infectious:'å‚³æŸ“',public:'å…¬è¡›'};

        // åˆå§‹åŒ–
        for(let y=114; y>=104; y--) db[y] = {pathology:[],pharmacology:[],diagnosis:[],general:[],infectious:[],public:[]};
        
        window.onload = () => {
            const saved = localStorage.getItem('vet_exam_v6');
            if(saved) {
                const d = JSON.parse(saved);
                state = {...state, ...d.state};
                if(d.db) { for(let y in d.db) { if(!db[y]) db[y]=d.db[y]; else for(let s in d.db[y]) db[y][s] = d.db[y][s]; }}
            }
            if(!state.errs) state.errs = {pathology:[],pharmacology:[],diagnosis:[],general:[],infectious:[],public:[]};
            
            renderYears();
            updateUI();
            checkDaily();
            switchMode(state.mode);
            switchYear(state.year);
        };

        function save() { localStorage.setItem('vet_exam_v6', JSON.stringify({state, db})); }
        function el(id) { return document.getElementById(id); }
        function els(sel) { return document.querySelectorAll(sel); }
        function show(id) { el(id).classList.remove('hidden'); }
        function hide(id) { el(id).classList.add('hidden'); }
        
        function changeView(v) { ['home','battle','import','shop'].forEach(x=>hide(`view-${x}`)); show(`view-${v}`); window.scrollTo(0,0); }
        function closeModal() { hide('msg-modal'); }
        function modal(t, d, i) { el('m-title').innerText=t; el('m-desc').innerText=d; el('m-icon').innerText=i; show('msg-modal'); }

        function renderYears() {
            let h = '', o = '';
            for(let y=114; y>=104; y--) {
                h += `<button onclick="switchYear('${y}')" id="yt-${y}" class="year-tab px-4 py-2 rounded-xl text-xs font-bold text-gray-500 bg-white border shadow-sm transition-all">${y}å¹´</button>`;
                o += `<option value="${y}">${y}å¹´</option>`;
            }
            el('year-tabs-container').innerHTML = h;
            el('i-year').innerHTML = o; el('m-year').innerHTML = o;
            el('m-year').onchange = updateMCount; el('m-sub').onchange = updateMCount;
        }

        function switchMode(m) {
            state.mode = m;
            if(m === 'year') {
                show('mode-year-content'); hide('mode-subject-content');
                el('btn-mode-year').className = "flex-1 py-3 rounded-lg text-xs font-bold bg-white text-indigo-600 shadow-sm";
                el('btn-mode-subject').className = "flex-1 py-3 rounded-lg text-xs font-bold text-gray-500";
            } else {
                hide('mode-year-content'); show('mode-subject-content');
                el('btn-mode-year').className = "flex-1 py-3 rounded-lg text-xs font-bold text-gray-500";
                el('btn-mode-subject').className = "flex-1 py-3 rounded-lg text-xs font-bold bg-white text-indigo-600 shadow-sm";
            }
            updateStats();
        }

        function switchYear(y) {
            state.year = y;
            els('.year-tab').forEach(e => { e.className="year-tab px-4 py-2 rounded-xl text-xs font-bold text-gray-500 bg-white border shadow-sm"; });
            const t = el(`yt-${y}`); if(t) { t.className="year-tab px-4 py-2 rounded-xl text-xs font-bold bg-indigo-600 text-white shadow-md transform scale-105"; t.scrollIntoView({behavior:'smooth',inline:'center'}); }
            el('year-display').innerText = `${y}å¹´`;
            updateStats();
        }

        function updateStats() {
            let total = 0, yTotal = 0, errTotal = 0;
            // è¨ˆç®—ç¸½é¡Œåº« & éŒ¯é¡Œ
            for(let y in db) for(let s in db[y]) total += db[y][s].length;
            for(let s in state.errs) errTotal += state.errs[s].length;
            
            els('.total-db-display').forEach(e => e.innerText = `ç¸½: ${total}`);
            els('.error-count-display').forEach(e => e.innerText = errTotal);

            // è¨ˆç®—ç•¶å‰é¡¯ç¤ºå€å¡Š
            els('.quest-count').forEach(e => {
                const s = e.dataset.sub;
                let c = 0;
                if(state.mode === 'year') {
                    if(db[state.year] && db[state.year][s]) c = db[state.year][s].length;
                } else {
                    for(let y in db) if(db[y][s]) c += db[y][s].length;
                }
                e.innerText = `${c} é¡Œ`;
                if(state.mode==='year') yTotal += c;
            });
            if(el('year-q-count')) el('year-q-count').innerText = state.mode==='year' ? yTotal : total;

            // æ›´æ–°éŒ¯é¡Œæ¨™ç±¤
            els('.error-badge').forEach(e => {
                const s = e.dataset.sub;
                const ec = state.errs[s] ? state.errs[s].length : 0;
                e.innerText = `${ec}éŒ¯`;
                e.style.display = ec > 0 ? 'block' : 'none';
            });
        }

        function updateUI() {
            el('coin-count').innerText = state.coin;
            el('level-circle').innerText = state.lv;
            el('xp-bar').style.width = `${(state.xp % (100*state.lv))/(100*state.lv)*100}%`;
            save();
        }

        // å°å…¥èˆ‡è§£æ V4
        function doImport() {
            const y = el('i-year').value, s = el('i-sub').value, qT = el('i-q').value; 
            let aT = el('i-a').value;
            if(!qT || !aT) return modal("éŒ¯èª¤", "è«‹è²¼ä¸Šå…§å®¹", "âŒ");
            
            try {
                aT = aT.replace(/[\uFF21-\uFF3A]/g, c => String.fromCharCode(c.charCodeAt(0)-65248));
                const ans = aT.replace(/[^A-E#]/gi, '').match(/[A-E#]+/gi);
                const qBlocks = qT.replace(/--- PAGE \d+ ---/g,'\n').split(/(?:\r\n|\r|\n)\s*(\d+)[\.\s]/);
                let parsed = [];
                
                for(let i=1; i<qBlocks.length; i+=2) {
                    const id = parseInt(qBlocks[i]), content = qBlocks[i+1];
                    if(!content) continue;
                    const parts = content.split(/\s[A-D][\.\s]/);
                    if(parts.length >= 4) {
                        const opts = parts.slice(1).map(o=>o.trim());
                        if(opts.length>=3) {
                            const aStr = ans && (id-1 < ans.length) ? ans[id-1] : null;
                            let cIdx = [];
                            if(aStr) {
                                if(aStr.includes('A')) cIdx.push(0); if(aStr.includes('B')) cIdx.push(1);
                                if(aStr.includes('C')) cIdx.push(2); if(aStr.includes('D')) cIdx.push(3);
                            }
                            if(cIdx.length) parsed.push({id, q:`${id}. ${parts[0].trim()}`, options:opts.slice(0,4), correct:cIdx});
                        }
                    }
                }
                if(parsed.length) {
                    parsed.sort((a,b)=>a.id-b.id);
                    db[y][s] = parsed.map(p=>({q:p.q, options:p.options, correct:p.correct}));
                    updateStats(); modal("æˆåŠŸ", `åŒ¯å…¥ ${parsed.length} é¡Œ`, "âœ¨");
                    el('i-q').value=''; el('i-a').value='';
                } else modal("å¤±æ•—", "ç„¡æ³•è§£æ", "âš ï¸");
            } catch(e) { modal("éŒ¯èª¤", "æ ¼å¼ç•°å¸¸", "âš ï¸"); }
        }

        // æˆ°é¬¥é‚è¼¯
        let session = {};
        function startDungeon(sub) {
            let pool = [], errs = state.errs[sub] || [];
            if(state.mode === 'year') {
                if(sub === 'mixed') Object.values(db[state.year]).forEach(a => pool.push(...a));
                else pool = db[state.year][sub] || [];
            } else {
                for(let y in db) {
                    if(sub === 'mixed') Object.values(db[y]).forEach(a => pool.push(...a));
                    else if(db[y][sub]) pool.push(...db[y][sub]);
                }
            }
            if(pool.length===0 && errs.length===0) return modal("ç©º", "ç„¡é¡Œç›®", "ğŸ“‚");

            let quiz = [];
            if(errs.length > 0) quiz = shuffle([...errs]).slice(0, 5);
            let need = 10 - quiz.length;
            if(need > 0 && pool.length > 0) quiz = [...quiz, ...shuffle([...pool]).slice(0, need)];
            
            session = { list: shuffle(quiz), idx: 0, correct: 0, sub: sub };
            changeView('battle');
            el('battle-subject').innerText = shortMap[sub] || sub;
            el('battle-year-tag').innerText = state.mode==='year'?`${state.year}å¹´`:'å…¨ç§‘';
            renderQ();
        }

        function renderQ() {
            const q = session.list[session.idx];
            el('battle-progress').innerText = `${session.idx+1}/${session.list.length}`;
            el('question-text').innerText = q.q;
            el('battle-error-tag').classList.toggle('hidden', !q.isError);
            el('options-box').innerHTML = q.options.map((o,i)=>
                `<button onclick="ans(${i},this)" class="option-btn w-full bg-white p-4 rounded-xl border text-left font-bold text-gray-700 shadow-sm flex gap-3"><span class="bg-slate-100 rounded px-2 text-sm">${String.fromCharCode(65+i)}</span><span>${o}</span></button>`
            ).join('');
        }

        function ans(i, btn) {
            if(btn.disabled) return;
            const q = session.list[session.idx];
            els('.option-btn').forEach(b=>b.disabled=true);
            const isRight = q.correct.includes(i);
            
            if(isRight) {
                btn.classList.add('bg-green-100', 'border-green-500');
                session.correct++; state.coin+=10; state.xp+=10;
                if(q.isError) {
                    state.errs[session.sub] = state.errs[session.sub].filter(x=>x.q!==q.q);
                    modal("è®š", "å·²ç§»é™¤éŒ¯é¡Œ", "ğŸ”¥");
                }
                setTimeout(nextQ, 800);
            } else {
                btn.classList.add('bg-red-50', 'border-red-500');
                q.correct.forEach(c => els('.option-btn')[c].classList.add('bg-green-50', 'border-green-500'));
                if(!q.isError) state.errs[session.sub].push({...q, isError:true});
                setTimeout(nextQ, 1500);
            }
            updateUI();
        }

        function nextQ() {
            session.idx++;
            if(session.idx < session.list.length) renderQ();
            else { modal("å®Œæˆ", `ç­”å° ${session.correct} é¡Œ`, "ğŸ†"); changeView('home'); updateStats(); }
        }

        function useItem() {
            if(el('view-battle').classList.contains('hidden')) return modal("æç¤º","æˆ°é¬¥ä¸­æ‰å¯ç”¨","â„¹ï¸");
            if(state.coin<100) return modal("ä¸è¶³","éœ€100é‡‘å¹£","ğŸ’¸");
            const q = session.list[session.idx], wrongs = [];
            q.options.forEach((_,i)=>{if(!q.correct.includes(i)) wrongs.push(i)});
            if(wrongs.length<2) return;
            shuffle(wrongs).slice(0,2).forEach(i=>els('.option-btn')[i].classList.add('opacity-20'));
            state.coin-=100; updateUI();
        }

        // ç®¡ç†åŠŸèƒ½
        function switchTab(t) {
            ['import','manage','backup'].forEach(x=>{
                el(`tab-${x}`).className="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500";
                hide(`panel-${x}`);
            });
            el(`tab-${t}`).className="flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-indigo-600";
            show(`panel-${t}`);
            if(t==='manage') updateMCount();
        }
        function updateMCount() {
            const y=el('m-year').value, s=el('m-sub').value;
            let c=0;
            if(s==='all') Object.values(db[y]).forEach(a=>c+=a.length);
            else c = db[y][s].length;
            el('m-count').innerText = c;
        }
        function doClear() {
            const y=el('m-year').value, s=el('m-sub').value, c=el('m-count').innerText;
            if(c==0) return modal("ç„¡è³‡æ–™","0ç­†","â„¹ï¸");
            if(confirm(`åˆªé™¤ ${c} ç­†?`)) {
                if(s==='all') db[y]={pathology:[],pharmacology:[],diagnosis:[],general:[],infectious:[],public:[]};
                else db[y][s]=[];
                updateStats(); updateMCount(); modal("å·²åˆªé™¤","","ğŸ—‘ï¸");
            }
        }
        function clearErrors() {
            if(confirm("æ¸…ç©ºæ‰€æœ‰éŒ¯é¡Œ?")) {
                state.errs = {pathology:[],pharmacology:[],diagnosis:[],general:[],infectious:[],public:[]};
                updateStats(); modal("å·²æ¸…ç©º","","âœ¨");
            }
        }
        function doExport() { el('b-code').value=JSON.stringify({state,db}); }
        function doRestore() { try{ const d=JSON.parse(el('b-code').value); state=d.state; db=d.db; save(); location.reload(); }catch(e){modal("éŒ¯èª¤","ä»£ç¢¼ç„¡æ•ˆ","âŒ");} }

        function checkDaily() {
            const t = new Date().toDateString();
            if(state.lastDate !== t) { state.lastDate = t; state.daily = [{t:"ç·´ç¿’ä¸€æ¬¡",max:1,cur:0},{t:"ç­”å°10é¡Œ",max:10,cur:0}]; }
            el('daily-quest-list').innerHTML = state.daily.map(q=>
                `<div class="flex justify-between text-xs p-2 bg-gray-50 rounded border ${q.cur>=q.max?'bg-green-50':''}"><span class="${q.cur>=q.max?'line-through':''}">${q.t}</span><span>${q.cur}/${q.max}</span></div>`
            ).join('');
        }
        function shuffle(a) { return a.sort(()=>Math.random()-0.5); }
    </script>
</body>
</html>